Как загрузить файл используя модель (вариант с тонким контроллером и толстой моделью)
=====================================================================================

Хорошей практикой считается создание тонких контроллеров и толстых моделей
всякий раз, когда это возможно. Это позволяет сделать код приложения более пригодным
для повторного использования.

Данный рецепт повторяет то, что уже было описано в рецепте
«[Как загрузить файл используя модель](form.file.upload)»
с той лишь разницей, что теперь мы не будем писать код, связанный с работой с файлами
в контроллере, а вынесем его в модель.

Кроме того в рецепте будет показана модель и контроллер для того случая,
когда нам может пригодится функционал не только добавления объекта модели с файлом
(`C` в `CRUD`), но и обновления файла при редактировании уже существующего объекта модели
(`U` в `CRUD`), который был создан ранее и хранится в базе данных.

Контроллер
==========

Контроллер обыкновенный, почти такой же, какой генерируется при помощи
[Gii](http://yiiframework.ru/doc/guide/ru/topics.gii). Контроллер не имеет понятия о том,
что нужно каким-либо образом иметь дело с загружаемыми файлами. Всё, чем он
занимается — общение с внешним миром.

~~~
[php]
class ItemController extends Controller{
    public function actionUpdate($id=null){
        // в зависимости от аргумента создаем модель или ищем уже существующую
        if($id===null)
            $model=new Item;
        else if(!$model=Item::model()->findByPk($id))
            throw new CHttpException(404);

        if(isset($_POST['Item'])){
            $model->attributes=$_POST['Item'];
            if($model->save()){
                // отображаем успешное сообщение, обновляем страницу
                // или перенаправляем куда-либо
                $this->refresh();
            }
        }

        $this->render('update',array('model'=>$model));
    }
}
~~~

Представление
=============

В представлении мы воспользуемся [CActiveForm]. Форму можно создавать и при помощи [CHtml], но т.к.
это уже было показано [в основном рецепте](http://yiiframework.ru/doc/cookbook/ru/form.file.upload),
то для разнообразия продемонстрируем отображение формы при помощи CActiveForm.

~~~
[php]
<?php /* @var $this ItemController */ ?>
<?php /* @var $model Item */ ?>

<?php /* @var $form CActiveForm */ $form=$this->beginWidget('CActiveForm',array(
    'htmlOptions'=>array('enctype'=>'multipart/form-data'),
)); ?>
    <div class="field">
        <?php echo $form->labelEx($model,'title'); ?>
        <?php echo $form->textField($model,'title'); ?>
        <?php echo $form->error($model,'title'); ?>
    </div>

    <div class="field">
        <?php if($model->document): ?>
            <p><?php echo CHtml::encode($model->document); ?></p>
        <?php endif; ?>
        <?php echo $form->labelEx($model,'document'); ?>
        <?php echo $form->fileField($model,'document'); ?>
        <?php echo $form->error($model,'document'); ?>
    </div>

    <div class="button">
        <?php echo CHtml::submitButton($model->isNewRecord ? 'Создать' : 'Сохранить'); ?>
    </div>
<?php $this->endWidget(); ?>
~~~

Ничего необычного: выводим два лейбла, одно текстовое поле, одно поле для загрузки файла,
название файла (если он уже был загружен ранее) и кнопку отправки формы.

Модель
======

Основная часть рецепта — это модель. Весь код по работе с отправленным файлом находится в модели:
валидация, обработка файла и его сохранение.

Основной принцип работы: мы переопределяем метод
[CActiveRecord::beforeSave], выполняемый перед сохранением AR-модели. В нём
получаем экземпляр класса загруженного файла и сохраняем его в нужное место на диске.

Обратите внимание на то, что у свойства `$document` установлено правило валидации `unsafe`
после правила `file`. Это необходимо для того, чтобы столбец, содержащий имя файла в таблице `{{item}}`
сохранил своё значение, если новый файл не был отправлен при обновлении модели.

~~~
[php]
/**
 * @property integer $id
 * @property string $title
 * @property string $document
 */
class Item extends CActiveRecord{
    public $document;

    public static function model($className=__CLASS__){
        return parent::model($className);
    }

    public function tableName(){
        return '{{item}}';
    }

    public function rules(){
        return array(
            array('title','required'),
            array('document','file','types'=>'doc,docx,xls,xlsx,odt,pdf','allowEmpty'=>true),
            array('document','unsafe'),
        );
    }

    public function beforeSave(){
        if(!parent::beforeSave())
            return false;

        if($document=CUploadedFile::getInstance($this,'document'))
        {
            $this->deleteDocument();
            $this->document=$document;
            $this->document->saveAs(Yii::getPathOfAlias('webroot.media').'/'.$this->document);
        }

        return true;
    }

    public function deleteDocument(){
        $documentPath=Yii::getPathOfAlias('webroot.media').'/'.$this->document;
        if(is_file($documentPath))
            unlink($documentPath);
    }
}
~~~

Код для работы с файлом при необходимости можно вынести в поведение ([CActiveRecordBehavior]).

---
  - `Оригинальный рецепт`: [как загрузить файл используя модель](form.file.upload)
  - `Английский рецепт`: [how to upload a file using a model](http://www.yiiframework.com/wiki/2/)
  - [File upload and update / error actions](http://www.yiiframework.com/wiki/2/#c3137)
  - `Автор`: [resurtm](http://yiiframework.ru/forum/memberlist.php?mode=viewprofile&u=1298)
  - `Обсуждение и комментарии`: [тема на форуме](http://yiiframework.ru/forum/)
